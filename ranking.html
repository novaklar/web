<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ranking de Afiliados | Novaklar</title>
  <link href="https://fonts.googleapis.com/css2?family=Comme:wght@700&display=swap" rel="stylesheet">
  <style>
    /* [Todos los estilos CSS anteriores se mantienen igual] */
  </style>
</head>
<body>
  <header>
    <img src="https://raw.githubusercontent.com/novaklar/web/refs/heads/main/Novaklar.svg" alt="Novaklar Logo" />
    <a href="https://novaklar.github.io/web/">Regresar</a>
  </header>

  <h1 class="page-title">Ranking de Afiliados</h1>

  <div class="ranking-container">
    <div id="loading" class="loading">Cargando datos...</div>
    <div id="error" class="error-message" style="display: none;"></div>
    
    <button id="refresh-btn" class="refresh-btn">
      <span id="refresh-text">Actualizar ahora</span>
      <span id="refresh-icon" style="margin-left: 5px;">â†»</span>
    </button>
    
    <table class="ranking-table" id="ranking-table" style="display: none;">
      <thead>
        <tr>
          <th>#</th>
          <th>Afiliado</th>
          <th>Ventas</th>
        </tr>
      </thead>
      <tbody id="ranking-body"></tbody>
    </table>
    
    <div id="last-updated" class="last-updated"></div>
  </div>

  <script>
    // ConfiguraciÃ³n
    const SPREADSHEET_ID = '1D54c79yejujdFIJKVu4m3iM3ndUVnxP_fSgwSqGec5U';
    const SHEET_NAME = 'Form_Responses';
    const RANGE = 'A:K';
    const AFFILIATE_COLUMNS = 10;
    const UPDATE_INTERVAL = 5 * 60 * 1000;

    // Elementos del DOM
    const rankingBody = document.getElementById('ranking-body');
    const loadingElement = document.getElementById('loading');
    const errorElement = document.getElementById('error');
    const tableElement = document.getElementById('ranking-table');
    const lastUpdatedElement = document.getElementById('last-updated');
    const refreshBtn = document.getElementById('refresh-btn');
    const refreshText = document.getElementById('refresh-text');
    const refreshIcon = document.getElementById('refresh-icon');

    let refreshInterval;

    function normalizeName(name) {
      return name
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .trim()
        .replace(/\s+/g, ' ');
    }

    function formatDate(date) {
      const options = { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
      };
      return new Date(date).toLocaleDateString('es-ES', options);
    }

    function spinRefreshIcon() {
      let rotation = 0;
      const spinInterval = setInterval(() => {
        rotation += 30;
        if (rotation >= 360) rotation = 0;
        refreshIcon.style.transform = `rotate(${rotation}deg)`;
      }, 50);
      return spinInterval;
    }

    function parseAffiliateData(text) {
      if (!text || typeof text !== 'string') return null;
      const lastSpaceIndex = text.lastIndexOf(' ');
      if (lastSpaceIndex === -1) return null;
      const name = text.substring(0, lastSpaceIndex).trim();
      const sales = parseInt(text.substring(lastSpaceIndex + 1));
      if (!name || isNaN(sales)) return null;
      return { name, sales };
    }

    function consolidateAffiliateData(rows) {
      const affiliatesMap = new Map();
      rows.forEach(row => {
        for (let i = 1; i <= AFFILIATE_COLUMNS; i++) {
          if (row.c[i]) {
            const cellValue = row.c[i]?.v || row.c[i]?.f || '';
            const affiliateData = parseAffiliateData(cellValue);
            if (affiliateData) {
              const normalizedName = normalizeName(affiliateData.name);
              const sales = affiliateData.sales;
              if (affiliatesMap.has(normalizedName)) {
                const existing = affiliatesMap.get(normalizedName);
                affiliatesMap.set(normalizedName, {
                  name: existing.name,
                  sales: existing.sales + sales
                });
              } else {
                affiliatesMap.set(normalizedName, {
                  name: affiliateData.name,
                  sales: sales
                });
              }
            }
          }
        }
      });
      return Array.from(affiliatesMap.values());
    }

    async function loadDataFromSheets() {
      let spinInterval;
      try {
        loadingElement.style.display = 'block';
        errorElement.style.display = 'none';
        refreshBtn.disabled = true;
        refreshText.textContent = 'Actualizando...';
        spinInterval = spinRefreshIcon();
        
        const cacheBuster = new Date().getTime();
        const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&range=${RANGE}&t=${cacheBuster}`;
        
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Error ${response.status}`);
        
        const text = await response.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        
        if (!json.table.rows || json.table.rows.length === 0) {
          throw new Error('No se encontraron datos en la hoja');
        }
        
        const affiliateData = consolidateAffiliateData(json.table.rows);
        if (affiliateData.length === 0) {
          throw new Error('No se encontraron datos vÃ¡lidos de afiliados');
        }
        
        affiliateData.sort((a, b) => b.sales - a.sales);
        
        rankingBody.innerHTML = '';
        affiliateData.forEach((affiliate, index) => {
          const row = document.createElement('tr');
          if (index === 0) row.classList.add('top-affiliate');
          
          const rankCell = document.createElement('td');
          rankCell.className = 'rank-number';
          
          if (index === 0) rankCell.innerHTML = `<span class="medal">ðŸ¥‡</span>${index + 1}`;
          else if (index === 1) rankCell.innerHTML = `<span class="medal">ðŸ¥ˆ</span>${index + 1}`;
          else if (index === 2) rankCell.innerHTML = `<span class="medal">ðŸ¥‰</span>${index + 1}`;
          else rankCell.textContent = index + 1;
          
          const nameCell = document.createElement('td');
          nameCell.className = 'affiliate-name';
          nameCell.textContent = affiliate.name;
          
          const salesCell = document.createElement('td');
          salesCell.className = 'sales-count';
          salesCell.textContent = affiliate.sales.toLocaleString('es-CO');
          
          row.append(rankCell, nameCell, salesCell);
          rankingBody.appendChild(row);
        });
        
        lastUpdatedElement.textContent = `Ãšltima actualizaciÃ³n: ${formatDate(new Date())}`;
        loadingElement.style.display = 'none';
        tableElement.style.display = 'table';
        
      } catch (error) {
        console.error('Error:', error);
        loadingElement.style.display = 'none';
        errorElement.textContent = `Error al cargar datos: ${error.message}`;
        errorElement.style.display = 'block';
      } finally {
        if (spinInterval) clearInterval(spinInterval);
        refreshBtn.disabled = false;
        refreshText.textContent = 'Actualizar ahora';
        refreshIcon.style.transform = 'rotate(0deg)';
      }
    }

    function startAutoRefresh() {
      loadDataFromSheets();
      refreshInterval = setInterval(loadDataFromSheets, UPDATE_INTERVAL);
    }

    refreshBtn.addEventListener('click', () => {
      clearInterval(refreshInterval);
      loadDataFromSheets();
      startAutoRefresh();
    });

    document.addEventListener('DOMContentLoaded', startAutoRefresh);
  </script>
</body>
</html>
