<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ranking de Afiliados | Novaklar</title>
  <link href="https://fonts.googleapis.com/css2?family=Comme:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8fafc;
      color: #333;
    }

    header {
      background-color: #00128f;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    header img {
      height: 40px;
      filter: brightness(0) invert(1);
    }

    header a {
      text-decoration: none;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    header a:hover {
      background-color: rgba(255,255,255,0.2);
    }

    .page-title {
      font-family: 'Comme', sans-serif;
      font-size: 2.2rem;
      font-weight: 700;
      color: #00128f;
      text-align: center;
      margin: 2rem 0 0.5rem;
      padding: 0 1rem;
    }

    .season-info {
      text-align: center;
      color: #00128f;
      font-size: 1.1rem;
      font-weight: 500;
      margin-bottom: 1.5rem;
    }

    .ranking-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 1.5rem 2rem;
    }

    .search-container {
      margin: 1.5rem 0;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 0.8rem 1rem 0.8rem 3rem;
      border: 2px solid #e2e8f0;
      border-radius: 0.6rem;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    .search-input:focus {
      outline: none;
      border-color: #6c91ff;
      box-shadow: 0 0 0 3px rgba(108, 145, 255, 0.2);
    }

    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
    }

    .ranking-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      box-shadow: 0 3px 15px rgba(0,0,0,0.08);
      border-radius: 0.8rem;
      overflow: hidden;
      background-color: white;
    }

    .ranking-table thead {
      background: linear-gradient(135deg, #6c91ff, #4a72da);
      color: white;
    }

    .ranking-table th {
      padding: 1.2rem 1rem;
      text-align: left;
      font-weight: 600;
      font-size: 1.05rem;
    }

    .ranking-table td {
      padding: 1rem;
      border-bottom: 1px solid #f1f5f9;
    }

    .ranking-table tbody tr:nth-child(even) {
      background-color: #f8fafc;
    }

    .ranking-table tbody tr:last-child td {
      border-bottom: none;
    }

    .ranking-table tbody tr:hover {
      background-color: #f1f7ff;
    }

    .rank-number {
      font-weight: bold;
      color: #6c91ff;
      width: 50px;
      text-align: center;
    }

    .affiliate-name {
      font-weight: 500;
    }

    .sales-count {
      text-align: right;
      font-weight: 600;
      color: #4a72da;
    }

    .top-affiliate {
      background-color: #f0f7ff !important;
      position: relative;
    }

    .top-affiliate::after {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
      background: linear-gradient(to bottom, #6c91ff, #4a72da);
    }

    .top-affiliate .rank-number {
      color: #4a72da;
      font-weight: 800;
    }

    .medal {
      display: inline-block;
      margin-right: 8px;
      font-size: 1.2em;
    }

    .loading {
      text-align: center;
      padding: 3rem;
      font-style: italic;
      color: #666;
      font-size: 1.1rem;
    }

    .loading i {
      display: block;
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #6c91ff;
    }

    .error-message {
      color: #d32f2f;
      background-color: #fde8e8;
      padding: 1.2rem;
      border-radius: 0.6rem;
      margin: 1rem 0;
      text-align: center;
      border-left: 4px solid #d32f2f;
    }

    .error-message i {
      margin-right: 0.5rem;
    }

    .last-updated {
      text-align: right;
      font-size: 0.85rem;
      color: #64748b;
      margin-top: 0.5rem;
      font-weight: 500;
    }

    .refresh-btn {
      display: block;
      margin: 1.5rem auto;
      padding: 0.8rem 1.5rem;
      background: linear-gradient(135deg, #6c91ff, #4a72da);
      color: white;
      border: none;
      border-radius: 0.6rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      box-shadow: 0 4px 6px rgba(108, 145, 255, 0.2);
    }

    .refresh-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(108, 145, 255, 0.3);
    }

    .refresh-btn:active {
      transform: translateY(0);
    }

    .refresh-btn:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .total-sales {
      background: linear-gradient(135deg, #6c91ff, #4a72da);
      color: white;
      padding: 1.2rem;
      border-radius: 0.8rem;
      margin-top: 2rem;
      text-align: center;
      font-weight: 600;
      font-size: 1.2rem;
      box-shadow: 0 4px 12px rgba(108, 145, 255, 0.3);
    }

    .total-sales span {
      font-weight: 700;
      font-size: 1.4rem;
    }

    .no-results {
      text-align: center;
      padding: 2rem;
      color: #64748b;
      font-style: italic;
    }

    .no-results i {
      font-size: 2rem;
      display: block;
      margin-bottom: 1rem;
      color: #cbd5e1;
    }

    @media (max-width: 768px) {
      .page-title {
        font-size: 1.8rem;
        margin: 1.5rem 0 0.5rem;
      }
      
      .season-info {
        font-size: 1rem;
        margin-bottom: 1rem;
      }
      
      .ranking-container {
        padding: 0 1rem 1.5rem;
      }
      
      .ranking-table th, 
      .ranking-table td {
        padding: 0.8rem;
        font-size: 0.9rem;
      }

      .total-sales {
        font-size: 1rem;
        padding: 1rem;
      }

      .total-sales span {
        font-size: 1.2rem;
      }
    }

    @media (max-width: 480px) {
      .page-title {
        font-size: 1.6rem;
      }
      
      header {
        padding: 0.8rem 1rem;
      }
      
      header img {
        height: 35px;
      }
      
      .ranking-table {
        font-size: 0.85rem;
      }
      
      .ranking-table th, 
      .ranking-table td {
        padding: 0.6rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="https://raw.githubusercontent.com/novaklar/web/refs/heads/main/Novaklar.svg" alt="Novaklar Logo" />
    <a href="https://novaklar.github.io/web/">Regresar</a>
  </header>

  <h1 class="page-title">Ranking de Afiliados</h1>
  <div class="season-info" id="season-info"></div>

  <div class="ranking-container">
    <div id="loading" class="loading">
      <i class="fas fa-spinner fa-spin"></i>
      Cargando datos...
    </div>
    <div id="error" class="error-message" style="display: none;">
      <i class="fas fa-exclamation-circle"></i>
      <span id="error-text"></span>
    </div>
    
    <button id="refresh-btn" class="refresh-btn">
      <span id="refresh-text">Actualizar ahora</span>
      <span id="refresh-icon" style="margin-left: 8px;"><i class="fas fa-sync-alt"></i></span>
    </button>

    <div class="search-container">
      <i class="fas fa-search search-icon"></i>
      <input type="text" id="search-input" class="search-input" placeholder="Buscar afiliado..." />
    </div>
    
    <table class="ranking-table" id="ranking-table" style="display: none;">
      <thead>
        <tr>
          <th>#</th>
          <th>Afiliado</th>
          <th>Ventas</th>
        </tr>
      </thead>
      <tbody id="ranking-body">
        <!-- Los datos se cargarán aquí con JavaScript -->
      </tbody>
    </table>

    <div id="no-results" class="no-results" style="display: none;">
      <i class="fas fa-search"></i>
      No se encontraron resultados para su búsqueda
    </div>

    <div id="total-sales" class="total-sales" style="display: none;">
      Total de ventas: <span id="total-sales-count">0</span>
    </div>
    
    <div id="last-updated" class="last-updated"></div>
  </div>

  <script>
    // Configuración
    const SPREADSHEET_ID = '1D54c79yejujdFIJKVu4m3iM3ndUVnxP_fSgwSqGec5U';
    const SHEET_NAME = 'Form_Responses1';
    const RANGE = 'A:K';
    const AFFILIATE_COLUMNS_START = 1; // Columna B (0-based sería 1)
    const AFFILIATE_COLUMNS_END = 10; // Columna K (0-based sería 10)
    const UPDATE_INTERVAL = 5 * 60 * 1000;
    
    // Configuración de temporadas (base: julio 2025 = temporada 23)
    const BASE_SEASON = 23;
    const BASE_YEAR = 2025;
    const BASE_MONTH = 6; // 0 = enero, 6 = julio

    // Elementos del DOM
    const rankingBody = document.getElementById('ranking-body');
    const loadingElement = document.getElementById('loading');
    const errorElement = document.getElementById('error');
    const errorTextElement = document.getElementById('error-text');
    const tableElement = document.getElementById('ranking-table');
    const lastUpdatedElement = document.getElementById('last-updated');
    const refreshBtn = document.getElementById('refresh-btn');
    const refreshText = document.getElementById('refresh-text');
    const refreshIcon = document.getElementById('refresh-icon');
    const totalSalesElement = document.getElementById('total-sales');
    const totalSalesCountElement = document.getElementById('total-sales-count');
    const seasonInfoElement = document.getElementById('season-info');
    const searchInput = document.getElementById('search-input');
    const noResultsElement = document.getElementById('no-results');

    // Variables globales
    let allAffiliates = [];
    let refreshInterval;

    // Función para calcular el mes y temporada actual
    function getCurrentSeasonInfo() {
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth();
      
      // Calcular la diferencia en meses desde la temporada base
      const monthsDiff = (currentYear - BASE_YEAR) * 12 + (currentMonth - BASE_MONTH);
      
      // Calcular la temporada actual
      const currentSeason = BASE_SEASON + Math.max(0, monthsDiff);
      
      // Nombres de los meses en español
      const monthNames = [
        'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
        'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
      ];
      
      return {
        month: monthNames[currentMonth],
        season: currentSeason
      };
    }

    // Función para actualizar la información de temporada
    function updateSeasonInfo() {
      const { month, season } = getCurrentSeasonInfo();
      seasonInfoElement.textContent = `${month} - temporada #${season}`;
    }

    // Función para formatear la fecha
    function formatDate(date) {
      const options = { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit'
      };
      return new Date(date).toLocaleDateString('es-ES', options);
    }

    // Función para animar el icono de actualización
    function spinRefreshIcon() {
      refreshIcon.classList.add('fa-spin');
    }

    function stopSpinRefreshIcon() {
      refreshIcon.classList.remove('fa-spin');
    }

    // Función mejorada para normalizar nombres - MÁS ROBUSTA
    function normalizeName(name) {
      if (!name || typeof name !== 'string') return '';
      
      return name
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Eliminar acentos
        .replace(/[^a-z0-9\s]/g, '') // Eliminar caracteres especiales
        .replace(/\s+/g, ' ') // Reemplazar múltiples espacios por uno solo
        .trim() // Eliminar espacios al inicio y final
        .replace(/\b\w/g, c => c.toUpperCase()); // Capitalizar cada palabra
    }

    // Función para limpiar y estandarizar nombres - NUEVA FUNCIÓN
    function cleanName(name) {
      if (!name || typeof name !== 'string') return '';
      
      // Lista de variaciones comunes de nombres
      const nameVariations = {
        'caroll': 'Caroll',
        'carroll': 'Caroll',
        'arias': 'Arias',
        'aryas': 'Arias',
        'aryaz': 'Arias'
      };
      
      // Aplicar normalización básica
      let cleaned = normalizeName(name);
      
      // Reemplazar variaciones conocidas
      Object.keys(nameVariations).forEach(variation => {
        const regex = new RegExp(`\\b${variation}\\b`, 'gi');
        cleaned = cleaned.replace(regex, nameVariations[variation]);
      });
      
      return cleaned;
    }

    // Función mejorada para parsear datos de afiliados
    function parseAffiliateData(text) {
      try {
        if (!text || typeof text !== 'string') return null;
        
        // Eliminar espacios extras y normalizar
        text = text.trim().replace(/\s+/g, ' ');
        
        // Patrones para detectar diferentes formatos
        const patterns = [
          // Formato: "Nombre X" (número al final)
          /^(.+?)\s+(\d+)$/,
          // Formato: "X Nombre" (número al inicio)
          /^(\d+)\s+(.+)$/,
          // Formato: "Nombre - X" (número después de guión)
          /^(.+?)\s*[-–—]\s*(\d+)$/,
          // Formato: "Nombre: X" (número después de dos puntos)
          /^(.+?)\s*[:]\s*(\d+)$/,
          // Formato: "Nombre (X)" (número entre paréntesis)
          /^(.+?)\s*[\(]\s*(\d+)\s*[\)]$/,
          // Solo nombre (asumir 1 venta)
          /^([a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+)$/
        ];
        
        let name, sales;
        
        for (const pattern of patterns) {
          const match = text.match(pattern);
          if (match) {
            if (pattern === /^([a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+)$/) {
              // Solo nombre
              name = match[1].trim();
              sales = 1;
            } else {
              // Nombre y número
              name = match[1].trim();
              sales = parseInt(match[2]);
            }
            
            // Validar resultados
            if (name && name.length >= 2 && !isNaN(sales) && sales > 0) {
              return {
                displayName: cleanName(name), // Usar la función de limpieza
                normalizedName: normalizeName(name),
                sales
              };
            }
          }
        }
        
        return null;
      } catch (error) {
        console.error('Error parsing affiliate data:', text, error);
        return null;
      }
    }

    // Función para consolidar datos de todas las columnas
    function consolidateAffiliateData(rows) {
      const affiliatesMap = new Map();
      let totalSales = 0;
      
      try {
        rows.forEach(row => {
          // Verificar si la fila tiene datos
          if (!row.c || !Array.isArray(row.c)) return;
          
          // Iterar sobre todas las columnas de afiliados (B a K)
          for (let i = AFFILIATE_COLUMNS_START; i <= AFFILIATE_COLUMNS_END; i++) {
            if (row.c[i]) {
              const cellValue = String(row.c[i]?.v || row.c[i]?.f || '');
              if (cellValue.trim()) {
                const affiliate = parseAffiliateData(cellValue);
                if (affiliate) {
                  totalSales += affiliate.sales;
                  const key = affiliate.normalizedName;
                  
                  if (affiliatesMap.has(key)) {
                    // Si ya existe, sumar las ventas
                    affiliatesMap.get(key).sales += affiliate.sales;
                  } else {
                    // Si no existe, agregar nuevo
                    affiliatesMap.set(key, {
                      name: affiliate.displayName,
                      sales: affiliate.sales,
                      normalizedName: affiliate.normalizedName
                    });
                  }
                }
              }
            }
          }
        });
        
        return {
          affiliates: Array.from(affiliatesMap.values()),
          totalSales: totalSales
        };
      } catch (error) {
        console.error('Error consolidating data:', error);
        return {
          affiliates: [],
          totalSales: 0
        };
      }
    }

    // Función para filtrar afiliados según la búsqueda
    function filterAffiliates(searchTerm) {
      if (!searchTerm) {
        return allAffiliates;
      }
      
      const normalizedSearch = normalizeName(searchTerm);
      return allAffiliates.filter(affiliate => 
        affiliate.normalizedName.includes(normalizedSearch)
      );
    }

    // Función para renderizar el ranking
    function renderRanking(affiliates) {
      rankingBody.innerHTML = '';
      
      if (affiliates.length === 0) {
        tableElement.style.display = 'none';
        noResultsElement.style.display = 'block';
        totalSalesElement.style.display = 'none';
        return;
      }
      
      tableElement.style.display = 'table';
      noResultsElement.style.display = 'none';
      totalSalesElement.style.display = 'block';
      
      // Ordenar por ventas (descendente) y luego por nombre (ascendente)
      affiliates.sort((a, b) => {
        if (b.sales !== a.sales) return b.sales - a.sales;
        return a.name.localeCompare(b.name);
      });
      
      affiliates.forEach((affiliate, index) => {
        const row = document.createElement('tr');
        if (index < 3) row.classList.add('top-affiliate');
        
        const rankCell = document.createElement('td');
        rankCell.className = 'rank-number';
        
        if (index === 0) rankCell.innerHTML = `<span class="medal">🥇</span>${index + 1}`;
        else if (index === 1) rankCell.innerHTML = `<span class="medal">🥈</span>${index + 1}`;
        else if (index === 2) rankCell.innerHTML = `<span class="medal">🥉</span>${index + 1}`;
        else rankCell.textContent = index + 1;
        
        const nameCell = document.createElement('td');
        nameCell.className = 'affiliate-name';
        nameCell.textContent = affiliate.name;
        
        const salesCell = document.createElement('td');
        salesCell.className = 'sales-count';
        salesCell.textContent = affiliate.sales.toLocaleString('es-CO');
        
        row.append(rankCell, nameCell, salesCell);
        rankingBody.appendChild(row);
      });
    }

    // Función para actualizar las estadísticas
    function updateStats(totalSales) {
      totalSalesCountElement.textContent = totalSales.toLocaleString('es-CO');
    }

    // Función para cargar datos desde Google Sheets
    async function loadDataFromSheets() {
      let spinInterval;
      try {
        loadingElement.style.display = 'block';
        errorElement.style.display = 'none';
        tableElement.style.display = 'none';
        noResultsElement.style.display = 'none';
        totalSalesElement.style.display = 'none';
        refreshBtn.disabled = true;
        refreshText.textContent = 'Actualizando...';
        spinRefreshIcon();
        
        const cacheBuster = new Date().getTime();
        const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&range=${RANGE}&t=${cacheBuster}`;
        
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
        
        const text = await response.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        
        if (!json.table?.rows) throw new Error('Estructura de datos inesperada');
        
        const affiliateData = consolidateAffiliateData(json.table.rows);
        if (affiliateData.affiliates.length === 0) {
          throw new Error('No se encontraron datos válidos de afiliados');
        }
        
        // Guardar todos los afiliados para búsqueda
        allAffiliates = affiliateData.affiliates;
        
        // Filtrar según búsqueda actual
        const searchTerm = searchInput.value;
        const filteredAffiliates = filterAffiliates(searchTerm);
        
        renderRanking(filteredAffiliates);
        updateStats(affiliateData.totalSales);
        
        lastUpdatedElement.textContent = `Última actualización: ${formatDate(new Date())}`;
        loadingElement.style.display = 'none';
        
      } catch (error) {
        console.error('Error:', error);
        loadingElement.style.display = 'none';
        errorTextElement.textContent = error.message;
        errorElement.style.display = 'block';
      } finally {
        stopSpinRefreshIcon();
        refreshBtn.disabled = false;
        refreshText.textContent = 'Actualizar ahora';
      }
    }

    // Inicia la actualización automática
    function startAutoRefresh() {
      updateSeasonInfo();
      loadDataFromSheets();
      refreshInterval = setInterval(loadDataFromSheets, UPDATE_INTERVAL);
    }

    // Evento para actualización manual
    refreshBtn.addEventListener('click', () => {
      clearInterval(refreshInterval);
      loadDataFromSheets();
      refreshInterval = setInterval(loadDataFromSheets, UPDATE_INTERVAL);
    });

    // Evento para búsqueda
    searchInput.addEventListener('input', () => {
      const searchTerm = searchInput.value;
      const filteredAffiliates = filterAffiliates(searchTerm);
      renderRanking(filteredAffiliates);
    });

    // Inicia al cargar la página
    document.addEventListener('DOMContentLoaded', startAutoRefresh);
  </script>
</body>
</html>
