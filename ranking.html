<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ranking de Afiliados | Novaklar</title>
  <link href="https://fonts.googleapis.com/css2?family=Comme:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: white;
      color: #333;
    }

    header {
      background-color: #081677;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    header img {
      height: 40px;
      filter: brightness(0) invert(1);
    }

    header a {
      text-decoration: none;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    header a:hover {
      background-color: rgba(255,255,255,0.2);
    }

    .page-title {
      font-family: 'Comme', sans-serif;
      font-size: 2.2rem;
      font-weight: 700;
      color: #081677;
      text-align: center;
      margin: 3rem 0 2rem;
      padding: 0 1rem;
    }

    .ranking-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 1.5rem 2rem;
    }

    .ranking-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      border-radius: 0.6rem;
      overflow: hidden;
    }

    .ranking-table thead {
      background-color: #89a2ff;
      color: white;
    }

    .ranking-table th {
      padding: 1rem;
      text-align: left;
      font-weight: 600;
    }

    .ranking-table td {
      padding: 0.8rem 1rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .ranking-table tbody tr:nth-child(even) {
      background-color: #f8fafc;
    }

    .ranking-table tbody tr:last-child td {
      border-bottom: none;
    }

    .ranking-table tbody tr:hover {
      background-color: #f1f5f9;
    }

    .rank-number {
      font-weight: bold;
      color: #89a2ff;
      width: 40px;
    }

    .affiliate-name {
      font-weight: 500;
    }

    .sales-count {
      text-align: right;
      font-weight: 600;
    }

    .top-affiliate {
      background-color: #f0f4ff !important;
    }

    .top-affiliate .rank-number {
      color: #89a2ff;
      font-weight: 800;
    }

    .medal {
      display: inline-block;
      margin-right: 8px;
      font-size: 1.2em;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      font-style: italic;
      color: #666;
    }

    .error-message {
      color: #d32f2f;
      background-color: #fde8e8;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
      text-align: center;
    }

    .last-updated {
      text-align: right;
      font-size: 0.8rem;
      color: #89a2ff;
      margin-top: 0.5rem;
      font-weight: 500;
    }

    .refresh-btn {
      display: block;
      margin: 1rem auto;
      padding: 0.5rem 1rem;
      background-color: #89a2ff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .refresh-btn:hover {
      background-color: #768fe6;
    }

    @media (max-width: 600px) {
      .page-title {
        font-size: 1.8rem;
        margin: 2rem 0 1.5rem;
      }
      
      .ranking-container {
        padding: 0 1rem 1.5rem;
      }
      
      .ranking-table th, 
      .ranking-table td {
        padding: 0.6rem 0.8rem;
        font-size: 0.9rem;
      }
    }

    @media (max-width: 400px) {
      .page-title {
        font-size: 1.6rem;
      }
      
      header {
        padding: 0.8rem 1rem;
      }
      
      header img {
        height: 35px;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="https://raw.githubusercontent.com/novaklar/web/refs/heads/main/Novaklar.svg" alt="Novaklar Logo" />
    <a href="https://novaklar.github.io/web/">Regresar</a>
  </header>

  <h1 class="page-title">Ranking de Afiliados</h1>

  <div class="ranking-container">
    <div id="loading" class="loading">Cargando datos...</div>
    <div id="error" class="error-message" style="display: none;"></div>
    
    <button id="refresh-btn" class="refresh-btn">Actualizar ahora</button>
    
    <table class="ranking-table" id="ranking-table" style="display: none;">
      <thead>
        <tr>
          <th>#</th>
          <th>Afiliado</th>
          <th>Ventas</th>
        </tr>
      </thead>
      <tbody id="ranking-body">
        <!-- Los datos se cargarán aquí con JavaScript -->
      </tbody>
    </table>
    
    <div id="last-updated" class="last-updated"></div>
  </div>

  <script>
    // Configuración
    const SPREADSHEET_ID = '1D54c79yejujdFIJKVu4m3iM3ndUVnxP_fSgwSqGec5U';
    const SHEET_NAME = 'Sheet1';
    const RANGE = 'A:B';
    const UPDATE_INTERVAL = 5 * 60 * 1000; // 5 minutos

    // Elementos del DOM
    const rankingBody = document.getElementById('ranking-body');
    const loadingElement = document.getElementById('loading');
    const errorElement = document.getElementById('error');
    const tableElement = document.getElementById('ranking-table');
    const lastUpdatedElement = document.getElementById('last-updated');
    const refreshBtn = document.getElementById('refresh-btn');

    // Variable para controlar el intervalo de actualización
    let refreshInterval;

    // Función para formatear la fecha
    function formatDate(date) {
      const options = { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
      };
      return new Date(date).toLocaleDateString('es-ES', options);
    }

    // Función para cargar datos desde Google Sheets
    async function loadDataFromSheets() {
      try {
        loadingElement.style.display = 'block';
        errorElement.style.display = 'none';
        refreshBtn.disabled = true;
        
        // Evitar caché con un parámetro único
        const cacheBuster = new Date().getTime();
        const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&range=${RANGE}&t=${cacheBuster}`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Error al cargar datos: ${response.status}`);
        }
        
        const text = await response.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        
        if (!json.table.rows || json.table.rows.length === 0) {
          throw new Error('No se encontraron datos en la hoja');
        }
        
        // Procesar los datos
        const affiliateData = json.table.rows.map(row => {
          return {
            name: row.c[0]?.v || '',
            sales: parseInt(row.c[1]?.v) || 0
          };
        }).filter(affiliate => affiliate.name && !isNaN(affiliate.sales));
        
        // Ordenar por ventas
        affiliateData.sort((a, b) => b.sales - a.sales);
        
        // Actualizar la tabla
        rankingBody.innerHTML = '';
        affiliateData.forEach((affiliate, index) => {
          const row = document.createElement('tr');
          
          // Destacar el primer puesto
          if (index === 0) {
            row.classList.add('top-affiliate');
          }
          
          // Celda de posición
          const rankCell = document.createElement('td');
          rankCell.className = 'rank-number';
          
          // Añadir medallas a los primeros puestos
          if (index === 0) {
            rankCell.innerHTML = `<span class="medal">🥇</span>${index + 1}`;
          } else if (index === 1) {
            rankCell.innerHTML = `<span class="medal">🥈</span>${index + 1}`;
          } else if (index === 2) {
            rankCell.innerHTML = `<span class="medal">🥉</span>${index + 1}`;
          } else {
            rankCell.textContent = index + 1;
          }
          
          // Celda de nombre
          const nameCell = document.createElement('td');
          nameCell.className = 'affiliate-name';
          nameCell.textContent = affiliate.name;
          
          // Celda de ventas
          const salesCell = document.createElement('td');
          salesCell.className = 'sales-count';
          salesCell.textContent = affiliate.sales.toLocaleString('es-CO');
          
          // Construir fila
          row.append(rankCell, nameCell, salesCell);
          rankingBody.appendChild(row);
        });
        
        // Actualizar marca de tiempo
        lastUpdatedElement.textContent = `Última actualización: ${formatDate(new Date())}`;
        
        // Mostrar tabla
        loadingElement.style.display = 'none';
        tableElement.style.display = 'table';
        refreshBtn.disabled = false;
        
      } catch (error) {
        console.error('Error al cargar datos:', error);
        loadingElement.style.display = 'none';
        errorElement.textContent = `Error al cargar datos: ${error.message}`;
        errorElement.style.display = 'block';
        refreshBtn.disabled = false;
      }
    }

    // Iniciar actualización automática
    function startAutoRefresh() {
      // Cargar datos inmediatamente
      loadDataFromSheets();
      
      // Configurar intervalo de actualización
      refreshInterval = setInterval(loadDataFromSheets, UPDATE_INTERVAL);
    }

    // Evento para el botón de actualización manual
    refreshBtn.addEventListener('click', () => {
      // Reiniciar el intervalo
      clearInterval(refreshInterval);
      startAutoRefresh();
    });

    // Iniciar cuando la página cargue
    document.addEventListener('DOMContentLoaded', startAutoRefresh);
  </script>
</body>
</html>
